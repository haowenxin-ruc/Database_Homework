<!-- [file name]: tasks.html -->
{% extends "base.html" %}

{% block title %}任务管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">汇总任务管理</h2>
        <p class="text-muted">创建并管理邮件汇总任务</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
        <i class="fas fa-plus me-2"></i>新建任务
    </button>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4" style="width: 25%">任务名称</th>
                        <th>截止时间</th>
                        <th>模板状态</th>
                        <th>进度</th>
                        <th class="text-end pe-4">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ task.task_name }}</div>
                            <small class="text-muted text-truncate d-block" style="max-width: 200px;">
                                {{ task.description or '无描述' }}
                            </small>
                        </td>
                        <td>
                            {% if task.deadline %}
                                <span class="{{ 'text-danger fw-bold' if task.deadline < now else '' }}">
                                    {{ task.deadline.strftime('%Y-%m-%d %H:%M') }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.template_fields %}
                                <span class="badge bg-info text-dark" onclick="viewTemplateFields({{ task.task_id }})" style="cursor:pointer">
                                    <i class="fas fa-table me-1"></i> {{ task.get_template_fields()|length }} 个字段
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">无模板</span>
                            {% endif %}
                        </td>
                        <td style="width: 15%">
                            <div class="d-flex align-items-center">
                                <a href="{{ url_for('task_summary', task_id=task.task_id) }}" class="btn btn-sm btn-link text-decoration-none px-0">
                                    查看汇总
                                </a>
                            </div>
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" title="发送邮件" onclick="sendTaskEmails({{ task.task_id }})">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <a href="{{ url_for('task_replies', task_id=task.task_id) }}" class="btn btn-sm btn-outline-info" title="监控回复">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('advanced_analysis_page', task_id=task.task_id) }}" class="btn btn-sm btn-outline-warning" title="高级图表分析">
                                    <i class="fas fa-chart-line"></i>
                                </a> 
                                <button class="btn btn-sm btn-outline-secondary" onclick="inspectTable({{ task.task_id }})" title="检查数据库表结构">
                                    <i class="fas fa-database"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" title="一键催办 (给未回复的人)" onclick="remindTaskEmails({{ task.task_id }}, '{{ task.task_name }}')">
                                    <i class="fas fa-bell"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" title="删除" onclick="deleteTask({{ task.task_id }}, '{{ task.task_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                               
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">暂无任务</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加任务模态框 -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTaskForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">任务名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="task_name" required placeholder="例如：2023年度科研成果汇总">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">任务描述</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">截止时间</label>
                        <input type="datetime-local" class="form-control" name="deadline">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">数据收集模板 (Excel) <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="template_file" accept=".xlsx,.xls" required>
                        <div class="form-text">请上传包含表头的Excel文件，第一行为字段名称。</div>
                    </div>
                    <!-- 【新增】教师选择区域 -->
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>选择参与教师 <span class="text-danger">*</span></span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="selectAllTeachers">
                                <label class="form-check-label small" for="selectAllTeachers">全选</label>
                            </div>
                        </label>
                        
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background: #f8f9fa;">
                            {% if teachers %}
                                {% for teacher in teachers %}
                                <div class="form-check">
                                    <input class="form-check-input teacher-checkbox" type="checkbox" 
                                        name="teacher_ids" value="{{ teacher.teacher_id }}" id="t_{{ teacher.teacher_id }}">
                                    <label class="form-check-label w-100" for="t_{{ teacher.teacher_id }}">
                                        <span class="fw-bold">{{ teacher.teacher_name }}</span>
                                        <small class="text-muted ms-2">({{ teacher.department }})</small>
                                    </label>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted small py-2">暂无教师，请先去教师管理页面添加</div>
                            {% endif %}
                        </div>
                        <div class="form-text">只有被选中的教师才会收到邮件并需要回复。</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">创建任务</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 字段查看模态框 -->
<div class="modal fade" id="viewFieldsModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">模板字段预览</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fieldsList"></div>
        </div>
    </div>
</div>
<!-- [file name]: templates/tasks.html (添加模态框) -->

<!-- 表结构检查模态框 -->
<div class="modal fade" id="inspectTableModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">数据库表结构检查</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="inspectContent">
                    <div class="text-center"><div class="spinner-border text-primary"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 添加任务
$('#addTaskForm').on('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    Utils.showLoading('正在创建任务并解析模板...');
    
    $.ajax({
        url: '/api/tasks',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Utils.hideLoading();
            if (response.success) {
                Swal.fire('成功', '任务创建成功', 'success').then(() => location.reload());
            } else {
                Swal.fire('失败', response.error, 'error');
            }
        },
        error: function() {
            Utils.hideLoading();
            Swal.fire('错误', '网络错误', 'error');
        }
    });
});
$('#selectAllTeachers').on('change', function() {
    $('.teacher-checkbox').prop('checked', $(this).is(':checked'));
});
// 发送邮件
function sendTaskEmails(taskId) {
    Swal.fire({
        title: '确认发送?',
        text: "将向所有未回复的教师发送邮件通知。",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '立即发送',
        cancelButtonText: '取消'
    }).then((result) => {
        if (result.isConfirmed) {
            Utils.showLoading('正在批量发送邮件，请勿关闭页面...');
            $.ajax({
                url: `/api/tasks/${taskId}/send-emails`,
                method: 'POST',
                success: function(response) {
                    Utils.hideLoading();
                    if (response.success) {
                        Swal.fire('发送完成', response.message, 'success');
                    } else {
                        Swal.fire('发送遇到问题', response.message || response.error, 'warning');
                    }
                },
                error: function() {
                    Utils.hideLoading();
                    Swal.fire('失败', '服务器连接超时', 'error');
                }
            });
        }
    });
}

// 删除任务
function deleteTask(taskId, name) {
    Swal.fire({
        title: '危险操作',
        text: `将永久删除任务 "${name}" 及其收集到的所有数据！`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: '确认删除',
        cancelButtonText: '取消'
    }).then((result) => {
        if (result.isConfirmed) {
            Utils.showLoading('正在清理数据...');
            $.ajax({
                url: '/api/tasks/' + taskId,
                method: 'DELETE',
                success: function(response) {
                    Utils.hideLoading();
                    if (response.success) {
                        Utils.toast('success', '任务已删除');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        Swal.fire('失败', response.error, 'error');
                    }
                }
            });
        }
    });
}

// 查看字段
function viewTemplateFields(taskId) {
    $.get(`/api/tasks/${taskId}/fields`, function(response) {
        if (response.success) {
            let html = '<ul class="list-group list-group-flush">';
            response.fields.forEach(f => {
                html += `<li class="list-group-item px-0 py-2"><i class="fas fa-tag text-muted me-2"></i>${f.name}</li>`;
            });
            html += '</ul>';
            $('#fieldsList').html(html);
            $('#viewFieldsModal').modal('show');
        }
    });
}
// [file name]: templates/tasks.html (Script 部分)

function inspectTable(taskId) {
    $('#inspectTableModal').modal('show');
    $('#inspectContent').html('<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">正在读取数据库元数据...</p></div>');
    
    $.ajax({
        url: `/api/tasks/${taskId}/inspect-table`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                renderInspectResult(response);
            } else {
                $('#inspectContent').html(`<div class="alert alert-danger">${response.error}</div>`);
            }
        },
        error: function() {
            $('#inspectContent').html(`<div class="alert alert-danger">网络请求失败</div>`);
        }
    });
}

function renderInspectResult(data) {
    let html = `
        <div class="alert ${data.table_exists ? 'alert-success' : 'alert-danger'} mb-3">
            <strong>物理表名:</strong> ${data.table_name} 
            <span class="badge ${data.table_exists ? 'bg-success' : 'bg-danger'} ms-2">
                ${data.table_exists ? '已创建 (正常)' : '未找到 (异常)'}
            </span>
        </div>
        
        <h6 class="fw-bold mt-4">字段映射详情 (Excel ↔ 数据库)</h6>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="bg-light">
                    <tr>
                        <th>原始 Excel 列名</th>
                        <th>数据库物理列名</th>
                        <th>物理表是否存在此列</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // 遍历映射关系
    const physicalColNames = data.physical_columns.map(c => c.name);
    
    // 1. 显示基础字段
    html += `
        <tr class="table-secondary">
            <td><em>(系统基础信息)</em></td>
            <td>teacher_name, email, reply_time...</td>
            <td><i class="fas fa-check text-success"></i></td>
        </tr>
    `;
    
    // 2. 显示动态字段
    for (let [excelName, dbName] of Object.entries(data.column_mapping)) {
        const exists = physicalColNames.includes(dbName);
        html += `
            <tr>
                <td class="fw-bold">${excelName}</td>
                <td class="font-monospace text-primary">${dbName}</td>
                <td class="text-center">
                    ${exists ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}
                </td>
            </tr>
        `;
    }
    
    html += `</tbody></table></div>`;
    
    // 显示物理表的所有列（调试用）
    html += `
        <div class="accordion mt-3" id="accordionDebug">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRaw">
                        查看物理表完整 Schema (调试用)
                    </button>
                </h2>
                <div id="collapseRaw" class="accordion-collapse collapse">
                    <div class="accordion-body bg-light">
                        <small><pre>${JSON.stringify(data.physical_columns, null, 2)}</pre></small>
                    </div>
                </div>
            </div>
        </div>
    `;

    $('#inspectContent').html(html);
}

function remindTaskEmails(taskId, taskName) {
    Swal.fire({
        title: '确认催办?',
        text: `将向 "${taskName}" 任务中所有【未回复】的教师发送温馨提醒邮件。`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107', // 黄色
        confirmButtonText: '立即催办',
        cancelButtonText: '取消'
    }).then((result) => {
        if (result.isConfirmed) {
            // 显示加载中
            if(typeof Utils !== 'undefined') Utils.showLoading('正在发送提醒邮件...');
            
            $.ajax({
                url: `/api/tasks/${taskId}/remind`,
                method: 'POST',
                success: function(response) {
                    if(typeof Utils !== 'undefined') Utils.hideLoading();
                    
                    if (response.success) {
                        Swal.fire('催办完成', response.message, 'success');
                    } else {
                        Swal.fire('催办失败', response.error, 'error');
                    }
                },
                error: function(xhr) {
                    if(typeof Utils !== 'undefined') Utils.hideLoading();
                    Swal.fire('网络错误', '无法连接到服务器', 'error');
                }
            });
        }
    });
}
</script>

{% endblock %}