<!-- [file name]: templates/ai_assistant.html -->
{% extends "base.html" %}

{% block title %}AI æ•°æ®åŠ©æ‰‹{% endblock %}
{% block header %}AI æ™ºèƒ½æ•°æ®åˆ†æ{% endblock %}
{% block subheader %}æ”¯æŒå¤šè½®å¯¹è¯ï¼Œæ·±å…¥æŒ–æ˜æ•°æ®ä»·å€¼{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-lg" style="height: 80vh;">
            <!-- å¤´éƒ¨ -->
            <div class="card-header bg-white p-3 border-bottom d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="input-group" style="max-width: 400px;">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-database"></i></span>
                        <select id="taskSelector" class="form-select border-0 bg-light" onchange="clearContext()">
                            <option value="" selected disabled>è¯·å…ˆé€‰æ‹©ä»»åŠ¡...</option>
                            {% for task in tasks %}
                                <option value="{{ task.task_id }}">{{ task.task_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <!-- æ¸…é™¤è®°å¿†æŒ‰é’® -->
                <button class="btn btn-sm btn-outline-danger" onclick="clearContext()" title="å¼€å¯æ–°å¯¹è¯">
                    <i class="fas fa-trash-alt me-1"></i> æ¸…ç©ºè®°å¿†
                </button>
            </div>

            <!-- èŠå¤©åŒº -->
            <div class="card-body overflow-auto bg-light" id="chatBox">
                <div class="d-flex flex-row mb-3">
                    <div class="p-3 bg-white rounded-3 shadow-sm" style="max-width: 80%;">
                        <p class="mb-0 fw-bold">ğŸ‘‹ æˆ‘æ˜¯ DeepSeek é©±åŠ¨çš„ AI åŠ©æ‰‹ã€‚</p>
                        <p class="mb-0 mt-2 text-muted small">æˆ‘å¯ä»¥è®°ä½æˆ‘ä»¬çš„èŠå¤©å†…å®¹ã€‚ä½ å¯ä»¥å°è¯•è¿™æ ·é—®ï¼š</p>
                        <ul class="mb-0 text-muted small ps-3 mt-1">
                            <li>ç¬¬ä¸€å¥ï¼š"å¸®æˆ‘æŸ¥ä¸€ä¸‹ç»è´¹è¶…è¿‡ 10 ä¸‡çš„è€å¸ˆã€‚"</li>
                            <li>ç¬¬äºŒå¥ï¼š"<b>ä»–ä»¬</b> ä¹‹ä¸­è°æ˜¯è®¡ç®—æœºç³»çš„ï¼Ÿ" (æˆ‘ä¼šçŸ¥é“"ä»–ä»¬"æŒ‡è°)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="card-footer bg-white p-3">
                <div class="input-group">
                    <input type="text" id="userInput" class="form-control border-0 bg-light py-3 ps-4" placeholder="è¾“å…¥é—®é¢˜ (æ”¯æŒå¤šè½®å¯¹è¯)..." style="border-radius: 30px 0 0 30px;">
                    <button class="btn btn-primary px-4" id="sendBtn" style="border-radius: 0 30px 30px 0;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// === å…¨å±€å˜é‡ ===
let chatHistory = []; 

// === é¡µé¢åŠ è½½æ—¶ï¼šæ¢å¤ç°åœº ===
$(document).ready(function() {
    // 1. å°è¯•æ¢å¤é€‰ä¸­çš„ä»»åŠ¡
    const savedTaskId = localStorage.getItem('ai_selected_task');
    if (savedTaskId) {
        $('#taskSelector').val(savedTaskId);
    }

    // 2. å°è¯•æ¢å¤å¯¹è¯ä¸Šä¸‹æ–‡æ•°æ®
    const savedHistory = localStorage.getItem('ai_chat_history');
    if (savedHistory) {
        chatHistory = JSON.parse(savedHistory);
    }

    // 3. å°è¯•æ¢å¤ç•Œé¢æ˜¾ç¤º (HTML)
    const savedHtml = localStorage.getItem('ai_chat_html');
    if (savedHtml && savedHtml.trim() !== "") {
        $('#chatBox').html(savedHtml);
        scrollToBottom();
    } else {
        // å¦‚æœæ²¡æœ‰å­˜æ¡£ï¼Œæ˜¾ç¤ºé»˜è®¤æ¬¢è¿è¯­
        // (HTMLé‡Œé»˜è®¤å†™äº†æ¬¢è¿è¯­ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œï¼Œé™¤éè¢«æ¸…ç©ºè¿‡)
    }
});

// === ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ° (æ ¸å¿ƒå‡½æ•°) ===
function saveState() {
    // 1. ä¿å­˜é€‰ä¸­çš„ä»»åŠ¡ID
    const taskId = $('#taskSelector').val();
    if (taskId) localStorage.setItem('ai_selected_task', taskId);

    // 2. ä¿å­˜ç»™ AI çœ‹çš„ä¸Šä¸‹æ–‡æ•°æ®
    localStorage.setItem('ai_chat_history', JSON.stringify(chatHistory));

    // 3. ä¿å­˜ç»™äººçœ‹çš„ HTML (åŒ…æ‹¬è¡¨æ ¼ç»“æœ)
    localStorage.setItem('ai_chat_html', $('#chatBox').html());
}

// === æ¸…ç©ºè®°å¿† ===
function clearContext() {
    chatHistory = [];
    
    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
    localStorage.removeItem('ai_chat_history');
    localStorage.removeItem('ai_chat_html');
    // localStorage.removeItem('ai_selected_task'); // ä»»åŠ¡IDå¯ä»¥é€‰æ‹©ä¿ç•™æˆ–æ¸…é™¤ï¼Œè¿™é‡Œä¿ç•™æ–¹ä¾¿

    // é‡ç½®ç•Œé¢
    $('#chatBox').html(`
        <div class="d-flex flex-row mb-3">
            <div class="p-3 bg-white rounded-3 shadow-sm border-start border-4 border-danger">
                <span class="text-muted">ğŸ—‘ï¸ å·²æ¸…ç©ºè®°å¿†ï¼Œå¼€å¯å…¨æ–°å¯¹è¯ã€‚</span>
            </div>
        </div>
    `);
}

// === ç›‘å¬ä»»åŠ¡åˆ‡æ¢ ===
$('#taskSelector').on('change', function() {
    // åˆ‡æ¢ä»»åŠ¡æ—¶ï¼Œé€šå¸¸åº”è¯¥æ¸…ç©ºä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢æŠŠ A ä»»åŠ¡çš„è¡¨åç”¨åˆ° B ä»»åŠ¡é‡Œ
    if (chatHistory.length > 0) {
        if(confirm('åˆ‡æ¢ä»»åŠ¡ä¼šæ¸…ç©ºå½“å‰çš„å¯¹è¯è®°å½•ï¼Œç¡®å®šå—ï¼Ÿ')) {
            clearContext();
            saveState(); // ä¿å­˜æ¸…ç©ºåçš„çŠ¶æ€
        } else {
            // æ¢å¤åŸæ¥çš„é€‰æ‹© (ç¨å¾®å¤æ‚ç‚¹ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)
            location.reload(); 
        }
    }
    // ä¿å­˜æ–°é€‰çš„ä»»åŠ¡ID
    localStorage.setItem('ai_selected_task', $(this).val());
});

// === å‘é€é€»è¾‘ ===
$('#sendBtn').click(sendMessage);
$('#userInput').keypress(function(e) { if(e.which == 13) sendMessage(); });

function sendMessage() {
    const taskId = $('#taskSelector').val();
    const text = $('#userInput').val().trim();
    
    if (!taskId) { Utils.toast('warning', 'è¯·å…ˆé€‰æ‹©ä»»åŠ¡'); return; }
    if (!text) return;

    // 1. ä¸Šå±ç”¨æˆ·é—®é¢˜
    appendMessage('user', text);
    $('#userInput').val('');
    const loadingId = appendLoading();

    // 2. æ›´æ–°å†å² & ä¿å­˜
    chatHistory.push({ "role": "user", "content": text });
    saveState(); // <--- ä¿å­˜

    // 3. å‘é€è¯·æ±‚
    $.ajax({
        url: '/api/ai/query',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            task_id: taskId, 
            messages: chatHistory 
        }),
        success: function(res) {
            removeLoading(loadingId);
            if (res.success) {
                // 4. æˆåŠŸï¼šæ›´æ–°å†å² & ä¿å­˜
                // è®°å½• AI çš„é€»è¾‘åŠ¨ä½œï¼Œè®©å®ƒä¸‹æ¬¡çŸ¥é“è‡ªå·±å¹²äº†å•¥
                chatHistory.push({ "role": "assistant", "content": `Executed SQL: ${res.result.sql}` });
                appendAIResult(res.result);
            } else {
                // å¤±è´¥ï¼šå›æ»šå†å² & ä¿å­˜
                chatHistory.pop(); 
                appendMessage('ai', 'âŒ å‡ºé”™äº†: ' + res.error);
            }
            saveState(); // <--- ä¿å­˜
        },
        error: function() {
            removeLoading(loadingId);
            chatHistory.pop();
            appendMessage('ai', 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥');
            saveState(); // <--- ä¿å­˜
        }
    });
}

// === UI æ¸²æŸ“è¾…åŠ©å‡½æ•° ===
function appendMessage(role, text) {
    const isUser = role === 'user';
    const align = isUser ? 'justify-content-end' : 'justify-content-start';
    const bg = isUser ? 'bg-primary text-white' : 'bg-white text-dark';
    $('#chatBox').append(`
        <div class="d-flex flex-row mb-3 ${align}">
            <div class="p-3 rounded-3 shadow-sm ${bg}" style="max-width: 80%;">${text}</div>
        </div>
    `);
    scrollToBottom();
    saveState(); // æ¯æ¬¡ç•Œé¢å˜åŠ¨éƒ½ä¿å­˜
}

function appendAIResult(result) {
    let html = `
        <div class="d-flex flex-row mb-3">
            <div class="p-3 bg-white rounded-3 shadow-sm w-100" style="max-width: 95%;">
                <div class="mb-2 d-flex justify-content-between align-items-center border-bottom pb-2">
                    <span class="badge bg-success">SQLæ‰§è¡ŒæˆåŠŸ (${result.count}æ¡)</span>
                    <button class="btn btn-sm btn-link text-muted p-0" style="text-decoration:none" onclick="$(this).parent().next().toggle()">æ˜¾ç¤º/éšè—SQL</button>
                </div>
                <div class="bg-light p-2 rounded mb-3 small font-monospace text-muted" style="display:none">
                    ${result.sql}
                </div>
    `;
    
    if (result.data && result.data.length > 0) {
        html += `<div class="table-responsive" style="max-height:400px;"><table class="table table-sm table-striped table-hover mb-0 small table-bordered"><thead><tr class="table-primary">`;
        for (let key in result.data[0]) html += `<th>${key}</th>`;
        html += `</tr></thead><tbody>`;
        result.data.forEach(row => {
            html += `<tr>`;
            for (let key in row) html += `<td>${row[key]}</td>`;
            html += `</tr>`;
        });
        html += `</tbody></table></div>`;
    } else {
        html += `<p class="text-muted mb-0 py-2">ğŸ¤” æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</p>`;
    }
    html += `</div></div>`;
    $('#chatBox').append(html);
    scrollToBottom();
    saveState(); // ä¿å­˜
}

function appendLoading() {
    const id = 'ld-' + Date.now();
    $('#chatBox').append(`<div id="${id}" class="d-flex flex-row mb-3"><div class="p-3 bg-white rounded-3 shadow-sm"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div><span class="text-muted small">AI æ­£åœ¨æ€è€ƒå¹¶æŸ¥è¯¢æ•°æ®åº“...</span></div></div>`);
    scrollToBottom();
    return id;
}

function removeLoading(id) { $('#' + id).remove(); }

function scrollToBottom() { 
    const box = document.getElementById('chatBox');
    box.scrollTop = box.scrollHeight; 
}
</script>
{% endblock %}