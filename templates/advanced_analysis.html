<!-- [file name]: templates/advanced_analysis.html -->
{% extends "base.html" %}

{% block title %}é«˜çº§åˆ†æ - {{ task.task_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">é«˜çº§æ•°æ®åˆ†æ</h2>
        <p class="text-muted">ä»»åŠ¡ï¼š{{ task.task_name }}</p>
    </div>
    <a href="{{ url_for('task_summary', task_id=task.task_id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>è¿”å›æ±‡æ€»è¡¨
    </a>
</div>

<!-- åŠ è½½çŠ¶æ€æç¤º -->
<div id="loadingMessage" class="alert alert-info text-center">
    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
    æ­£åœ¨è¿›è¡ŒAIæ•°æ®åˆ†æï¼Œè¯·ç¨å€™...
</div>

<!-- é”™è¯¯æç¤ºå®¹å™¨ -->
<div id="errorMessage" class="alert alert-danger text-center" style="display: none;"></div>

<!-- æ¦‚è§ˆå¡ç‰‡ -->
<div class="row g-3 mb-4" id="statsCards" style="display: none;">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h3 class="fw-bold" id="stat-rate">0%</h3>
                <p class="mb-0">æ€»ä½“å›å¤ç‡</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <h3 class="fw-bold" id="stat-replied">0</h3>
                <p class="mb-0">å·²å›å¤äººæ•°</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body text-center">
                <h3 class="fw-bold" id="stat-total">0</h3>
                <p class="mb-0">æ€»äººæ•°</p>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row" id="chartsArea" style="visibility: hidden;">
    <!-- 1. å›å¤è¶‹åŠ¿å›¾ -->
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">ğŸ“… å›å¤è¶‹åŠ¿ (éšæ—¶é—´å˜åŒ–)</div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. éƒ¨é—¨ç»Ÿè®¡å›¾ -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">ğŸ¢ å„éƒ¨é—¨å›å¤ç‡</div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. å­—æ®µå¡«å†™ç‡ -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">ğŸ“ å­—æ®µå¡«å†™å®Œæ•´åº¦</div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="fieldChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. å›å¤æ—¶é—´åˆ†å¸ƒ -->
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">â±ï¸ å›å¤è€—æ—¶åˆ†å¸ƒ (å°æ—¶)</div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="timeChart"></canvas>
                </div>
                <div id="timeStatsText" class="mt-3 text-center text-muted small"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å›¾è¡¨å®ä¾‹
let charts = {};

$(document).ready(function() {
    loadAnalysisData();
});

function loadAnalysisData() {
    console.log("å¼€å§‹è¯·æ±‚åˆ†ææ•°æ®...");
    
    $.ajax({
        url: '/api/tasks/{{ task.task_id }}/analysis/comprehensive',
        method: 'GET',
        success: function(response) {
            console.log("æ”¶åˆ°æ•°æ®:", response);
            $('#loadingMessage').hide();
            
            if (response.success && response.analysis) {
                $('#statsCards').fadeIn();
                $('#chartsArea').css('visibility', 'visible').hide().fadeIn();
                
                const data = response.analysis;
                
                // 1. æ¸²æŸ“æ¦‚è§ˆå¡ç‰‡
                if (data.basic_stats) {
                    $('#stat-rate').text(data.basic_stats.reply_rate + '%');
                    $('#stat-replied').text(data.basic_stats.replied_teachers);
                    $('#stat-total').text(data.basic_stats.total_teachers);
                }

                // 2. æ¸²æŸ“å„ä¸ªå›¾è¡¨
                renderTrendChart(data.trend_analysis);
                renderDepartmentChart(data.department_analysis);
                renderFieldChart(data.field_analysis);
                renderTimeChart(data.time_analysis);
                
            } else {
                showError('è·å–çš„æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
            }
        },
        error: function(xhr, status, error) {
            console.error("è¯·æ±‚å¤±è´¥:", error);
            $('#loadingMessage').hide();
            showError('æ•°æ®è¯·æ±‚å¤±è´¥: ' + error);
        }
    });
}

function showError(msg) {
    $('#errorMessage').text(msg).show();
}

// é”€æ¯æ—§å›¾è¡¨é˜²æ­¢é‡å 
function destroyChart(id) {
    if (charts[id]) {
        charts[id].destroy();
    }
}

// --- å›¾è¡¨æ¸²æŸ“å‡½æ•° ---

// 1. è¶‹åŠ¿å›¾ (Line)
function renderTrendChart(data) {
    if (!data || !data.dates || data.dates.length === 0) {
        console.warn("è¶‹åŠ¿å›¾æ•°æ®ä¸ºç©º");
        return;
    }
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    destroyChart('trend');
    
    charts['trend'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'ç´¯è®¡å›å¤æ•°',
                data: data.replied,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
}

// 2. éƒ¨é—¨å›¾ (Bar)
function renderDepartmentChart(data) {
    if (!data || Object.keys(data).length === 0) return;
    
    const labels = Object.keys(data);
    const values = labels.map(k => data[k].reply_rate); // ä½¿ç”¨å›å¤ç‡
    
    const ctx = document.getElementById('departmentChart').getContext('2d');
    destroyChart('dept');
    
    charts['dept'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'éƒ¨é—¨å›å¤ç‡ (%)',
                data: values,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
}

// 3. å­—æ®µå›¾ (Horizontal Bar)
function renderFieldChart(data) {
    if (!data || Object.keys(data).length === 0) return;
    
    const labels = Object.keys(data);
    const values = labels.map(k => data[k].fill_rate);
    
    const ctx = document.getElementById('fieldChart').getContext('2d');
    destroyChart('field');
    
    charts['field'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'å­—æ®µå¡«å†™ç‡ (%)',
                data: values,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // æ¨ªå‘
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, max: 100 }
            }
        }
    });
}

// 4. æ—¶é—´åˆ†å¸ƒå›¾ (Bar/Histogram)
function renderTimeChart(data) {
    if (!data || !data.histogram || data.histogram.counts.length === 0) {
        $('#timeChart').parent().html('<div class="text-center pt-5 text-muted">æš‚æ— è¶³å¤Ÿçš„æ—¶é—´æ•°æ®</div>');
        return;
    }
    
    // æ„å»ºåŒºé—´æ ‡ç­¾ (e.g., "0-2h", "2-4h")
    const bins = data.histogram.bins;
    const labels = [];
    for(let i=0; i<bins.length-1; i++) {
        labels.push(`${Math.round(bins[i])}-${Math.round(bins[i+1])}h`);
    }
    
    const ctx = document.getElementById('timeChart').getContext('2d');
    destroyChart('time');
    
    charts['time'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'å›å¤äººæ•°åˆ†å¸ƒ',
                data: data.histogram.counts,
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // æ˜¾ç¤ºç»Ÿè®¡æ–‡å­—
    if(data.mean) {
        $('#timeStatsText').html(`
            <span class="badge bg-light text-dark border">å¹³å‡è€—æ—¶: ${data.mean}å°æ—¶</span>
            <span class="badge bg-light text-dark border ms-2">æœ€å¿«: ${data.min}å°æ—¶</span>
            <span class="badge bg-light text-dark border ms-2">æœ€æ…¢: ${data.max}å°æ—¶</span>
        `);
    }
}
</script>
{% endblock %}